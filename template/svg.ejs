<%
fontSizeLimit = function(text, fontSize, maxWidth){
    let totalWidth = 0;
    let str = "";
    for(let char of text){
        // if its space or a number
        if(char === ' ' || /^\d+$/.test(char))
            totalWidth += fontSize * 0.7;
        // if its thin character
        else if(char.toLowerCase() === 'i' || char === 'f' || char === 'l' || char === 'j' || char === 'r' || char === 't' || char === '"' || char === "'" || char === '(' || char === ')' || char === ',' || char === '-' || char === '.')
            totalWidth += fontSize * 0.3;
        // if it's uppercase
        else if(char === char.toUpperCase())
            totalWidth += fontSize * 1.04;
        // all other symbols
        else
            totalWidth += fontSize * 0.8;
        if(totalWidth < maxWidth - 13)
            str += char;
        else
            return str + '...';
    }
    return str;
}
%>

<svg
        width="200"
        height="<%= 74+(recentPlayed.length-1)*42 %>"
        viewBox="0 0 200 <%= 74+(recentPlayed.length-1)*42 %>"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink"
        style="transform: scale(1.4) translate(15%, 15%);"
>
    <rect width="200" height="<%= 73+(recentPlayed.length-1)*42 %>" rx="4" fill="#212121" />
    <rect x="178" y="8" width="15" height="13" fill="url(#pattern-logo)" />

    <text
            fill="white"
            xml:space="preserve"
            style="white-space: pre"
            font-size="10"
            letter-spacing="0em"
    >
  <tspan x="6" y="<%= 18.93 %>">Recently Played</tspan>
</text>
    <%
            for (const [index, value] of recentPlayed.entries()) {
    %>
        <rect
                x="6"
                y="<%= 27+index*42 %>"
                width="188"
                height="37"
                rx="2"
                fill="white"
                fill-opacity="0.11"
        />
        <rect x="10" y="<%= 31+index*42 %>" width="29" height="29" rx="2" fill="<%= `url(#pattern${index})` %>" />
        <text
                fill="white"
                xml:space="preserve"
                style="white-space: pre"
                font-size="8"
                letter-spacing="0em"
        >
  <tspan x="43" y="<%= 42.844+index*42 %>"><%= fontSizeLimit(recentPlayed[index].name,8,220) %></tspan>
  </text>
        <text
                fill="white"
                fill-opacity="0.66"
                xml:space="preserve"
                style="white-space: pre"
                font-size="7"
                letter-spacing="0em"
        >
    <tspan x="43" y="<%= 54.258+index*42 %>"><%= fontSizeLimit(recentPlayed[index].artist, 7, 220)  %></tspan>
</text>
    <%
    }
    %>
    <defs>
        <pattern
                id="pattern-logo"
                patternContentUnits="objectBoundingBox"
                width="1"
                height="1"
        >
            <use
                    xlink:href="#image-logo"
                    transform="translate(0 -0.00103455) scale(0.00129639 0.00141336)"
            />
        </pattern>
        <%
        for (const [index] of recentPlayed.entries()) {
        %>
            <pattern
                    id="<%= `pattern${index}` %>"
                    patternContentUnits="objectBoundingBox"
                    width="1"
                    height="1"
            >
                <use xlink:href="<%= `#image${index}` %>" transform="scale(0.00333333)" />
            </pattern>
        <%
        }
        %>
        <%
        for (const [index, value] of recentPlayed.entries()) {
        %>
            <image
                    id="<%= `image${index}` %>"
                    width="300"
                    height="300"
                    xlink:href="<%= value.cover %>"
            />
        <%
        }
        %>
        <image
                id="image-logo"
                width="2362"
                height="709"
                xlink:href="<%= recentPlayed[0].logo %>"
        />
        <style>
            <style type="text/css">
                                  text{
                                      font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;
                                  }
        </style>
        </style>
    </defs>
</svg>
